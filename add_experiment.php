<?php // php form
include 'db_connect.php'; //creating $conn SQLi connection database

$employees = $conn->query(  // retriving from the employeee table of the database
    "SELECT Employee_ID, NAME, Employee_Type
     FROM Employee
     ORDER BY NAME"
);

if ($_SERVER["REQUEST_METHOD"] == "POST") { // the code inside on runs when the form is submitted
    // reading user input
    // creates array
    $name       = $_POST['name'];
    $objective  = $_POST['objective'];
    $start_date = $_POST['start_date'];
    $end_date   = $_POST['end_date'];
    $emp_ids    = $_POST['employees']; 

    $stmt = $conn->prepare( // prepared statement to protect against sql injection
        "INSERT INTO Experiment (NAME, Objective, Start_Date, End_Date)
         VALUES (?, ?, ?, ?)"   // placeholder for secure insertation
    );
    $stmt->bind_param("ssss", $name, $objective, $start_date, $end_date); // attach PHP variables to SQL query placeholders
    $stmt->execute(); // ssss implies name, object. start_date, end_state are strings

    $experiment_id = $stmt->insert_id; // autogenerated primary key
    $stmt->close(); // closes prepared statement

    if (!empty($emp_ids)) {
        $stmt2 = $conn->prepare(
            "INSERT INTO Participates (Employee_ID, Experiment_ID)
             VALUES (?, ?)" // ? is placeholder for secure insertation
        );
        // Inserts one row per employee–experiment pair.
        foreach ($emp_ids as $emp_id) {
            $stmt2->bind_param("ii", $emp_id, $experiment_id); // ii interpretes the values as integer
            $stmt2->execute();
        }
        $stmt2->close(); // closes prepared statement
    }
    // Displays confirmation after successful insertion.
    echo "<p style='color:green;'><b>✔ Experiment created successfully</b></p>";
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add New Experiment</title>

<style>
    body { font-family: Arial; background: #f9f9f9; }
    form {
        width: 450px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label { display: block; margin-top: 12px; }
    input, textarea, select {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
    }
    select { height: 140px; }
    button {
        margin-top: 15px;
        padding: 10px;
        width: 100%;
        background: #2c7be5;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover { background: #1a5dc9; }
</style>
</head>

<body>

<h2 style="text-align:center;">Create New Experiment</h2>

<form method="POST">

    <label>Experiment Name</label>
    <input type="text" name="name" required>

    <label>Objective</label>
    <textarea name="objective" rows="3" required></textarea> 

    <label>Start Date</label>
    <input type="date" name="start_date" required>

    <label>End Date</label>
    <input type="date" name="end_date" required>

    <label>Assign Employees (Ctrl + Click for multiple)</label>
    <select name="employees[]" multiple>
        <?php while ($e = $employees->fetch_assoc()) { ?>
            <option value="<?= $e['Employee_ID'] ?>">
                <?= htmlspecialchars($e['NAME']) ?> (<?= $e['Employee_Type'] ?>)
            </option>
        <?php } ?>
    </select>

    <button type="submit">Create Experiment</button>

</form>
</body>
</html>
